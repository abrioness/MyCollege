@model WebColegio.Models.ViewModel.ColeccionCatalogos
 @{
	ViewData["Title"] = "Estado de Cuenta Administrador";
} 


<div class="container-fluid p-1" style="padding:2px;">
	<div class="card shadow-lg p-3 mb-5 bg-white rounded">
		<div class="card-header bg-primary text-white">
			<h5 class="mb-0"><i class="bi bi-graph-up-arrow"></i>  Estado Cuenta de Estudiante</h5>
		</div>

		<div class="card-body">

			<div class="table-responsive" style="font-size:12px">
				<br />
				<div class="col-12 text-end">
					<div class="btn-goup">
						<button type="button" class="btn btn-danger dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">Agregar Pagos Mensualidad</button>


						<ul class="dropdown-menu">
							<li>
								<a class="dropdown-item" asp-action="Create" asp-controller="Pagos">
									Agregar Pago de Mensualidad
								</a>
							</li>
							<li>
								<a class="dropdown-item" asp-action="Index" asp-controller="Pagos">
									Reporte de Pagos de Mensualidad
								</a>
							</li>
							@* <li><hr class="dropdown-divider"></li>
						<li><a class="dropdown-item" href="#">Otra opción</a></li> *@
						</ul>
					</div>

				</div> 
				<br />

				<table id="estadocuenta" class="table table-bordered table-sm">
					@* class="display responsive nowrap" style="width:100%"> *@
					<thead>
						<tr>
							<th>Alumno</th>
							<th>Grado</th>
							<th>Matrícula</th>
							<th>Colegio</th>
							<th>Concepto</th>
							<th>Pago Rifa</th>
							<th>Pago Mensualidad</th>
							<th>Enero</th>
							<th>Febrero</th>
							<th>Marzo</th>
							<th>Abril</th>
							<th>Mayo</th>
							<th>Junio</th>
							<th>Julio</th>
							<th>Agosto</th>
							<th>Septiembre</th>
							<th>Octubre</th>
							<th>Noviembre</th>
							<th>Diciembre</th>
							<th>Sub Total</th>
							<th>Mora Anterior</th>
							<th>Abono Cta Morosa</th>
							<th>Gran Total</th>
							<th>Saldo 2024</th>
						</tr>
					</thead>
					<tbody>
						@foreach (var pagos in Model.pagos)
						{
							<tr>
								@{
									var alumno = Model.alumno.FirstOrDefault(al => al.IdAlumno == pagos.IdAlumno);
								}
								<td>

									<a class="btn btn-sm btn-info" asp-action="Edit" asp-controller="Pagos" asp-route-id="@pagos.IdPago">

										@alumno?.Nombre @alumno?.Apellido
									</a>
								</td>

								@* Buscar grado y periodo asociados si aplica *@
								@{
									var grado = Model.grados.FirstOrDefault(g => g.IdGrado == alumno.IdGrado);
									// var periodo = Model.periodo.FirstOrDefault(p => p.IdPeriodo == alumno.IdPeriodo);

								}

								<td>@(grado?.NombreGrado ?? "-")</td>
								@{

									var periodo = Model.periodo.FirstOrDefault(p => p.IdPeriodo == pagos.IdPeriodo);

								}
								<td>@(periodo?.Periodo.ToString() ?? "-")</td>
								@{

									var colegio = Model.recintos.FirstOrDefault(p => p.IdRecinto == pagos.IdRecinto);

								}
								<td>@(colegio?.Recinto.ToString() ?? "-")</td>
								@{

									var concepto = Model.tipoMovimiento.FirstOrDefault(p => p.IdTipoMovimiento == pagos.IdTipoMovimiento);

								}
								<td>@(concepto?.Concepto.ToString() ?? "-")</td>

								@* Columna: Estado de Rifa (por semestre) *@
								 @{
									// Obtener el año actual
									int añoActual = periodo.IdPeriodo;
									
									// Buscar el IdTipoMovimiento para "Rifa" 
									// Ajusta el filtro según cómo tengas configurado en tu base de datos
									var tipoRifa = Model.tipoMovimiento.FirstOrDefault(tm => 
										tm.Concepto.Contains("Rifas"));
									
									// Semestre 1: Enero-Junio (meses 1-6)
									// Semestre 2: Julio-Diciembre (meses 7-12)
									bool tieneRifaSemestre1 = false;
									bool tieneRifaSemestre2 = false;
									
									if (tipoRifa != null)
									{
										// Verificar si tiene pago de rifa del semestre 1 (meses 1-6)
										tieneRifaSemestre1 = Model.pagos.Any(p => 
											p.IdAlumno == alumno.IdAlumno && 
											p.IdTipoMovimiento == tipoRifa.IdTipoMovimiento &&
											p.IdMes.HasValue && p.IdMes >= 1 &&//&& p.IdMes <= 6 &&
											p.IdPeriodo == añoActual &&
											p.Activo == true);
										
										// Verificar si tiene pago de rifa del semestre 2 (meses 7-12)
										tieneRifaSemestre2 = Model.pagos.Any(p => 
											p.IdAlumno == alumno.IdAlumno && 
											p.IdTipoMovimiento == tipoRifa.IdTipoMovimiento &&
											p.IdMes.HasValue && p.IdMes >= 7 &&// p.IdMes <= 12 &&
											p.IdPeriodo == añoActual &&
											p.Activo == true);
									}
									
									string estadoRifa = (tieneRifaSemestre1 && tieneRifaSemestre2) ? "Solvente" : "Insolvente";
									string claseRifa = (tieneRifaSemestre1 && tieneRifaSemestre2) ? "success" : "danger";
								}
								<td>
									<span class="badge bg-@claseRifa">@estadoRifa</span>
								</td> 

								@* Columna: Estado de Mensualidad *@
								@{
									// Buscar el IdTipoMovimiento para "Mensualidad"
									// Ajusta el filtro según cómo tengas configurado en tu base de datos
									var tipoMensualidad = Model.tipoMovimiento.FirstOrDefault(tm => 
										tm.Concepto.ToLower().Contains("mensualidad") || 
										tm.Concepto.ToLower().Contains("mensual"));
									
									int mesActual = DateTime.Now.Month;
									int añoActualMensualidad = DateTime.Now.Year;
									
									// Si estamos en diciembre (mes 12), debe tener pagado noviembre (mes 11)
									// Si estamos en cualquier otro mes, debe tener pagado el mes anterior
									int mesRequerido = mesActual == 12 ? 11 : (mesActual - 1);
									
									bool tieneMensualidadAlDia = false;
									
									if (tipoMensualidad != null && mesRequerido > 0)
									{
										// Verificar si tiene pago de mensualidad del mes requerido
										tieneMensualidadAlDia = Model.pagos.Any(p => 
											p.IdAlumno == alumno.IdAlumno && 
											p.IdTipoMovimiento == tipoMensualidad.IdTipoMovimiento &&
											p.IdMes.HasValue && p.IdMes == mesRequerido &&
											p.Anyo == añoActualMensualidad &&
											p.Activo == true);
									}
									
									string estadoMensualidad = tieneMensualidadAlDia ? "Solvente" : "Insolvente";
									string claseMensualidad = tieneMensualidadAlDia ? "success" : "danger";
								}
								<td>
									<span class="badge bg-@claseMensualidad">@estadoMensualidad</span>
								</td>


								@* @{
									var tipoMovimiento = Model.tipoMovimiento.FirstOrDefault(tip => tip.IdTipoMovimiento == pagos.IdTipoMovimiento);
								}
								<td>@(tipoMovimiento.Concepto.ToString() ?? "-")</td> *@
						@if(User.Identity.IsAuthenticated)
							{
									@if (User.IsInRole("Cajero"))
									{
										@for (int mes = 1; mes <= 12; mes++)
										{
											var pagoMes = Model.pagos
											.FirstOrDefault(p => p.IdAlumno == alumno.IdAlumno && p.IdMes == mes);

											if (pagoMes != null)
											{
												<td> <span class="badge bg-success">Pagado</span></td>
											}
											else
											{
												<td><span class="badge bg-warning text-dark">Pendiente</span></td>
											}
										}
									}
						else
							{
							
								decimal subtotal = 0;
							
														@* Mostrar columnas de los 12 meses *@
							@for (int mes = 1; mes <= 12; mes++)
							{
								var pagoMes = Model.pagos
								.FirstOrDefault(p => p.IdAlumno == alumno.IdAlumno && p.IdMes == mes && p.Activo==true);

								if (pagoMes != null)
								{
												subtotal += pagoMes.Monto;
									<td>C$ @pagoMes.Monto</td>
									
												@* <td>C$ @pagoMes.Monto</td>
												<td>C$ @pagoMes.Monto</td>
												<td>C$ @pagoMes.Monto</td>
												<td>C$ @pagoMes.Monto</td>
												<td>C$ @pagoMes.Monto</td> *@
								}
								else
								{
									<td>C$ 0.00</td>
												

								}
							}

										<td><strong>C$ @subtotal</strong></td>
										<td><strong>C$ 0.00</strong></td>
										<td><strong>C$ 0.00</strong></td>
										<td><strong>C$ 0.00</strong></td>
										<td><strong>C$ 0.00</strong></td>
									}
													}
						</tr>
					}
				</tbody>

			</table>
			
		</div>
		</div>
	</div>
</div>

<script> 
	$(document).ready(function () {
			$('#estadocuenta').DataTable({
			responsive: false,
			dom: 'Bfrtip', // Botones + filtro + tabla
			buttons: [
				{
					extend: 'excelHtml5',
					text: 'Exportar a Excel',
					className: 'btn btn-success'
				}
			],
			language: {
				url: "//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json"
			}
		});
	});
</script>