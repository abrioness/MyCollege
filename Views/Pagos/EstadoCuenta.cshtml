@model WebColegio.Models.ViewModel.ColeccionCatalogos
@* @{
	ViewData["Title"] = "Index";
} *@
@* <script src="~/js/site.js"></script> *@
@* <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css" /> *@

<div class="container p-1" style="padding:2px;">
	<div class="card shadow-lg p-3 mb-5 bg-white rounded">
		<div class="card-header bg-primary text-white">
			<h5 class="mb-0"><i class="bi bi-cash-coin"></i> Estado Cuenta de Estudiante</h5>
		</div>

		<div class="card-body">
			<div class="table-responsive" style="font-size:12px">
			<br />
				@* <div class="col-12 text-end">

				<a asp-action="Create" class="btn btn-primary">
					<i class="bi bi-plus-circle"></i> Agregar Pago
				</a>
			</div> 
			<br />*@
			
				<table id="estadocuenta" class="table table-bordered table-sm">
					@* class="display responsive nowrap" style="width:100%"> *@
					<thead>
						<tr>
							<th>Alumno</th>
							<th>Grado</th>
							<th>Matricula</th>
							<th>Enero</th>
							<th>Febrero</th>
							<th>Marzo</th>
							<th>Abril</th>
							<th>Mayo</th>
							<th>Junio</th>
							<th>Julio</th>
							<th>Agosto</th>
							<th>Septiembre</th>
							<th>Octubre</th>
							<th>Noviembre</th>
							<th>Diciembre</th>
							<th>Sub Total</th>
							<th>Mora Anterior</th>
							<th>Abono Cta Morosa</th>
							<th>Gran Total</th>
							<th>Saldo 2024</th>
						</tr>
					</thead>
					<tbody>
						@foreach (var alumno in Model.alumno)
						{
							<tr>
								<td>

									<span  class="btn btn-sm btn-info">

										@alumno.Nombre @alumno.Apellido
									</span>
								</td>

								@* Buscar grado y periodo asociados si aplica *@
								@{
									var grado = Model.grados.FirstOrDefault(g => g.IdGrado == alumno.IdGrado);
									var periodo = Model.periodo.FirstOrDefault(p => p.IdPeriodo == alumno.IdPeriodo);
									
								}

							<td>@(grado?.NombreGrado ?? "-")</td>
							<td>@(periodo?.Periodo.ToString() ?? "-")</td>
						@if(User.Identity.IsAuthenticated)
							{
									@if (User.IsInRole("Cajero"))
									{
										@for (int mes = 1; mes <= 12; mes++)
										{
											var pagoMes = Model.pagos
											.FirstOrDefault(p => p.IdAlumno == alumno.IdAlumno && p.IdMes == mes);

											if (pagoMes != null)
											{
												<td> <span class="badge bg-success">Pagado</span></td>
											}
											else
											{
												<td><span class="badge bg-warning text-dark">Pendiente</span></td>
											}
										}
									}
						else
							{
							
								decimal subtotal = 0;
							
														@* Mostrar columnas de los 12 meses *@
							@for (int mes = 1; mes <= 12; mes++)
							{
								var pagoMes = Model.pagos
								.FirstOrDefault(p => p.IdAlumno == alumno.IdAlumno && p.IdMes == mes && p.Activo==true);

								if (pagoMes != null)
								{
												subtotal += pagoMes.Monto;
									<td>C$ @pagoMes.Monto</td>
									
												@* <td>C$ @pagoMes.Monto</td>
												<td>C$ @pagoMes.Monto</td>
												<td>C$ @pagoMes.Monto</td>
												<td>C$ @pagoMes.Monto</td>
												<td>C$ @pagoMes.Monto</td> *@
								}
								else
								{
									<td>C$ 0.00</td>
												

								}
							}

										<td><strong>C$ @subtotal</strong></td>
										<td><strong>C$ 0.00</strong></td>
										<td><strong>C$ 0.00</strong></td>
										<td><strong>C$ 0.00</strong></td>
										<td><strong>C$ 0.00</strong></td>
									}
													}
						</tr>
					}
				</tbody>

			</table>
			
		</div>
		</div>
	</div>
</div>
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script>
	$(document).ready(function () {
			$('#estadocuenta').DataTable({
			responsive: false,
			dom: 'Bfrtip', // Botones + filtro + tabla
			buttons: [
				{
					extend: 'excelHtml5',
					text: 'Exportar a Excel',
					className: 'btn btn-success'
				}
			],
			language: {
				url: "//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json"
			}
		});
	});
</script>